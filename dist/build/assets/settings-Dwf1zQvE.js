document.getElementById("settingsForm");document.querySelector('input[name="site_logo"]');document.querySelector('img[src*="site_logo"]');document.querySelector('input[name="site_favicon"]');document.querySelector('img[src*="site_favicon"]');document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".settings-form").forEach(t=>{f(t)}),typeof jQuery<"u"&&typeof $.fn.select2<"u"&&$(".select2").select2(),typeof $.fn.colorpicker<"u"&&$(".colorpicker").each(function(){$(this).colorpicker({format:"hex"}).on("colorpickerChange",function(t){$(this).closest(".input-group").find(".color-preview").css("background-color",t.color.toString())})}),document.querySelectorAll('input[type="file"]').forEach(t=>{const n=t.parentElement.querySelector("img");n&&u(t,n)}),m(),p()});function u(e,s){!e||!s||e.addEventListener("change",function(){if(this.files&&this.files[0]){const t=new FileReader;t.onload=function(n){s.src=n.target.result,s.style.display="block"},t.readAsDataURL(this.files[0])}})}function f(e){e.addEventListener("submit",async function(s){s.preventDefault();const t=e.querySelector('button[type="submit"]');t&&(t.disabled=!0,t.innerHTML='<i class="spinner-border spinner-border-sm me-1"></i> Saving...');try{const n=new FormData(e),i=await fetch(e.getAttribute("action"),{method:"POST",body:n,headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},credentials:"same-origin"});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const r=await i.json();if(r.success)l(r.message||"Settings updated successfully"),r.reload&&setTimeout(()=>window.location.reload(),1e3);else throw new Error(r.message||"Failed to update settings")}catch(n){console.error("Settings update error:",n),a(n.message||"An error occurred while saving settings")}finally{t&&(t.disabled=!1,t.innerHTML="Save Changes")}})}function m(){const e=document.querySelector("#test-smtp-btn");e&&e.addEventListener("click",async function(s){s.preventDefault(),e.disabled=!0,e.innerHTML='<i class="spinner-border spinner-border-sm me-1"></i> Testing...';try{const t=await fetch(e.dataset.url,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,Accept:"application/json"},credentials:"same-origin"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();if(n.success)l(n.message);else throw new Error(n.message||"SMTP test failed")}catch(t){console.error("SMTP test error:",t),a(t.message||"Failed to test SMTP connection")}finally{e.disabled=!1,e.innerHTML="Test SMTP Connection"}})}function p(){const e=document.querySelector("#testEmailModal");if(!e)return;const s=e.querySelector("#send-test-email-btn"),t=e.querySelector("#test_email"),n=e.dataset.url;if(!s||!t||!n){console.error("Required elements for test email not found");return}s.addEventListener("click",async function(i){i.preventDefault();const r=t.value.trim();if(!r){a("Please enter a test email address");return}s.disabled=!0,s.innerHTML='<i class="spinner-border spinner-border-sm me-1"></i> Sending...';try{const o=await fetch(n,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content,"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({test_email:r}),credentials:"same-origin"});if(!o.ok)throw new Error(`HTTP error! status: ${o.status}`);const c=await o.json();if(c.success){l(c.message);const d=bootstrap.Modal.getInstance(e);d&&d.hide(),t.value=""}else throw new Error(c.message||"Failed to send test email")}catch(o){console.error("Test email error:",o),a(o.message||"Failed to send test email")}finally{s.disabled=!1,s.innerHTML="Send Test Email"}})}function l(e){typeof Swal<"u"?Swal.fire({title:"Success!",text:e,icon:"success",customClass:{confirmButton:"btn btn-primary"},buttonsStyling:!1}):alert(e)}function a(e){typeof Swal<"u"?Swal.fire({title:"Error!",text:e,icon:"error",customClass:{confirmButton:"btn btn-danger"},buttonsStyling:!1}):alert(e)}
