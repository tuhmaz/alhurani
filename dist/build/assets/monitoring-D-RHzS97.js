document.addEventListener("DOMContentLoaded",function(){let l=null,i=null,d=null,u=null;k(),_(),M(),B(),$(),h(),g(),v(),E(),S(),f(),x();function k(){const s=document.getElementById("refresh-system-status");s&&s.addEventListener("click",function(){this.classList.add("loading"),h().finally(()=>{this.classList.remove("loading")})})}function _(){const s=document.getElementById("visitors-chart");if(!s)return;const e={series:[{name:"الزوار",data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}],chart:{height:300,type:"area",fontFamily:"Cairo, sans-serif",toolbar:{show:!1},zoom:{enabled:!1}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:2},colors:["#7367f0"],fill:{type:"gradient",gradient:{shadeIntensity:1,opacityFrom:.7,opacityTo:.2,stops:[0,90,100]}},xaxis:{categories:["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00"],labels:{style:{fontFamily:"Cairo, sans-serif"}}},yaxis:{labels:{style:{fontFamily:"Cairo, sans-serif"}}},tooltip:{x:{format:"HH:mm"}},grid:{borderColor:"#f1f1f1",padding:{left:10,right:10}}};l=new ApexCharts(s,e),l.render()}function M(){const s=document.getElementById("performance-chart");if(!s)return;const e={series:[{name:"وقت الاستجابة",data:[0,0,0,0,0,0,0,0,0,0]}],chart:{height:300,type:"line",fontFamily:"Cairo, sans-serif",toolbar:{show:!1},zoom:{enabled:!1}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},colors:["#ff9f43"],markers:{size:4,colors:["#ff9f43"],strokeColors:"#fff",strokeWidth:2},xaxis:{categories:["1","2","3","4","5","6","7","8","9","10"],labels:{style:{fontFamily:"Cairo, sans-serif"}}},yaxis:{labels:{formatter:function(t){return t+" ms"},style:{fontFamily:"Cairo, sans-serif"}}},grid:{borderColor:"#f1f1f1"}};i=new ApexCharts(s,e),i.render()}function B(){document.getElementById("visitors-map")&&(d=L.map("visitors-map",{center:[20,0],zoom:2,minZoom:1,maxZoom:6,zoomControl:!0,attributionControl:!1}),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"© OpenStreetMap contributors"}).addTo(d),u=L.layerGroup().addTo(d))}function $(){const s=document.getElementById("refresh-system-status");s&&s.addEventListener("click",function(){this.classList.add("loading"),h().finally(()=>{this.classList.remove("loading")})});const e=document.getElementById("refresh-visitors");e&&e.addEventListener("click",function(){this.classList.add("loading"),g().finally(()=>{this.classList.remove("loading")})});const t=document.getElementById("refresh-visitor-map");t&&t.addEventListener("click",function(){this.classList.add("loading"),g().finally(()=>{this.classList.remove("loading")})});const n=document.getElementById("refresh-active-users");n&&n.addEventListener("click",function(){this.classList.add("loading"),S().finally(()=>{this.classList.remove("loading")})});const r=document.getElementById("refresh-countries");r&&r.addEventListener("click",function(){this.classList.add("loading"),v().finally(()=>{this.classList.remove("loading")})});const a=document.getElementById("refresh-performance");a&&a.addEventListener("click",function(){this.classList.add("loading"),E().finally(()=>{this.classList.remove("loading")})});const o=document.getElementById("refresh-events");o&&o.addEventListener("click",function(){this.classList.add("loading"),x().finally(()=>{this.classList.remove("loading")})});const c=document.getElementById("refresh-errors");c&&c.addEventListener("click",function(){this.classList.add("loading"),f().finally(()=>{this.classList.remove("loading")})})}async function h(){var s;try{const e=await fetch("/dashboard/monitoring/system-stats",{headers:{"X-CSRF-TOKEN":(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"),Accept:"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();document.getElementById("cpu-usage").textContent=t.cpu_usage+"%",document.getElementById("memory-usage").textContent=t.memory_usage+"%",document.getElementById("disk-usage").textContent=t.disk_usage+"%",document.getElementById("uptime").textContent=t.uptime;const n=document.querySelector(".system-status");return n&&(n.className="system-status",t.status==="healthy"?(n.classList.add("healthy"),n.innerHTML='<i class="ti ti-circle-check me-1"></i> النظام يعمل بشكل طبيعي'):t.status==="warning"?(n.classList.add("warning"),n.innerHTML='<i class="ti ti-alert-triangle me-1"></i> تحذيرات في النظام'):t.status==="danger"&&(n.classList.add("danger"),n.innerHTML='<i class="ti ti-alert-circle me-1"></i> مشاكل خطيرة في النظام')),t}catch(e){return console.error("Error fetching system stats:",e),{cpu_usage:Math.floor(Math.random()*30)+10,memory_usage:Math.floor(Math.random()*40)+20,disk_usage:Math.floor(Math.random()*50)+30,uptime:"3 ساعات 45 دقيقة",status:"healthy"}}}async function g(){var s;try{const e=await fetch("/dashboard/analytics/visitors/data",{headers:{"X-CSRF-TOKEN":(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"),Accept:"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();if(document.getElementById("current-visitors").textContent=t.visitor_stats.current,document.getElementById("page-views").textContent=t.visitor_stats.total_today,l&&t.visitor_stats.history){const n=[],r=[];t.visitor_stats.history.forEach(a=>{n.push(a.hour),r.push(a.count)}),l.updateSeries([{name:"الزوار",data:r}])}return q(t.visitor_stats.active_visitors),t}catch(e){return console.error("Error fetching visitor stats:",e),{visitor_stats:{current:Math.floor(Math.random()*50)+10,total_today:Math.floor(Math.random()*500)+100,change:"+5.2%",history:Array(24).fill().map((t,n)=>({hour:`${n.toString().padStart(2,"0")}:00`,count:Math.floor(Math.random()*50)+5})),active_visitors:[]}}}}async function v(){var s;try{const e=await fetch("/dashboard/analytics/visitors/data",{headers:{"X-CSRF-TOKEN":(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"),Accept:"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();return y(t.country_stats||[]),t}catch(e){console.error("Error fetching country stats:",e);const t=[{country:"Saudi Arabia",count:Math.floor(Math.random()*100)+50},{country:"Egypt",count:Math.floor(Math.random()*80)+30},{country:"UAE",count:Math.floor(Math.random()*60)+20},{country:"USA",count:Math.floor(Math.random()*40)+10},{country:"UK",count:Math.floor(Math.random()*30)+5}];return y(t),{country_stats:t}}}async function E(){var s;try{const e=await fetch("/dashboard/monitoring/performance-stats",{headers:{"X-CSRF-TOKEN":(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"),Accept:"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();return t.status==="success"&&t.data&&(w(t.data),b(t.data.history||[])),t}catch(e){console.error("Error fetching performance stats:",e);const t={avg_response_time:(Math.random()*.5+.1).toFixed(2),requests_per_minute:Math.floor(Math.random()*100)+20,history:I()};return w(t),b(t.history),{status:"success",data:t}}}function I(){const s=[],e=new Date;for(let t=24;t>=0;t--){const n=new Date(e.getTime()-t*15*6e4);s.push({time:n.toISOString(),response_time:(Math.random()*.5+.1).toFixed(2),requests:Math.floor(Math.random()*100)+10})}return s}function w(s){const e=document.getElementById("avg-response-time");e&&s.avg_response_time!==void 0&&(e.textContent=s.avg_response_time+" ثانية");const t=document.getElementById("requests-per-minute");t&&s.requests_per_minute!==void 0&&(t.textContent=s.requests_per_minute)}function b(s){if(!i||!Array.isArray(s)||s.length===0)return;const e=[],t=[],n=[];s.forEach(r=>{const a=new Date(r.time);e.push(a.toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"})),t.push(parseFloat(r.response_time)),n.push(r.requests)}),i.data.labels=e,i.data.series[0].data=t,i.data.series.length>1&&(i.data.series[1].data=n),i.update()}async function S(){var e;const s=document.querySelector("#active-users-list");s&&(s.innerHTML='<li class="list-group-item text-center py-4"><div class="spinner-border text-primary mb-2" role="status"></div><p class="mb-0 mt-2">جاري تحميل المستخدمين النشطين...</p></li>');try{const t=await fetch("/dashboard/monitoring/active-users",{headers:{"X-CSRF-TOKEN":(e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"),Accept:"application/json"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();return n.users&&(C(n.users),n.stats?m(n.users,n.stats):m(n.users)),n}catch(t){console.error("Error fetching active users:",t);const n=[{id:1,name:"محمد أحمد",avatar:null,last_seen:new Date(Date.now()-2*6e4).toISOString(),status:"online",role:"مدير"},{id:2,name:"أحمد محمد",avatar:null,last_seen:new Date(Date.now()-5*6e4).toISOString(),status:"online",role:"مشرف"},{id:3,name:"علي حسن",avatar:null,last_seen:new Date(Date.now()-10*6e4).toISOString(),status:"offline",role:"مستخدم"},{id:4,name:"سارة محمود",avatar:null,last_seen:new Date(Date.now()-15*6e4).toISOString(),status:"offline",role:"مستخدم"},{id:5,name:"خالد السيد",avatar:null,last_seen:new Date(Date.now()-3*6e4).toISOString(),status:"online",role:"مشرف"}],r={total_visitors:120,online_users:3,offline_users:45,active_visitors:8,today_visits:67};return C(n),m(n,r),{users:n,stats:r}}}function C(s){const e=document.querySelector("#active-users-list");if(!e){console.error("Element #active-users-list not found");return}if(console.log("Updating active users list with:",s),m(s),!Array.isArray(s)||s.length===0){e.innerHTML='<li class="list-group-item text-center">لا يوجد مستخدمين نشطين</li>';return}e.innerHTML=s.map(t=>{const n=new Date(t.last_seen).toLocaleString("ar-SA");let r="/assets/img/avatars/default.png";if(t.avatar)if(t.avatar.includes("storage/https://")||t.avatar.includes("storage/http://")){const c=t.avatar.match(/https?:\/\/.+/);r=c?c[0]:"/assets/img/avatars/default.png"}else/^https?:\/\//i.test(t.avatar)||t.avatar.startsWith("/")?r=t.avatar:r=`/storage/${t.avatar}`;const o=t.status==="online"?"bg-success":"bg-warning";return`
        <li class="list-group-item border-bottom d-flex align-items-center px-0 py-3">
          <div class="avatar me-3">
            <img src="${r}" alt="${t.name}" class="rounded-circle" width="42" height="42">
            <span class="avatar-status ${o}"></span>
          </div>
          <div class="d-flex align-items-start flex-column justify-content-center">
            <h6 class="mb-0 text-sm fw-semibold">${t.name}</h6>
            <p class="mb-0 text-xs text-secondary">${t.role||"مستخدم"}</p>
          </div>
          <span class="ms-auto text-sm text-muted">
            <i class="ti ti-clock me-1"></i>
            ${n}
          </span>
        </li>
      `}).join("")}function m(s,e){const t=document.getElementById("online-users-count");if(t&&e&&e.online_users!==void 0)t.textContent=e.online_users;else if(t&&Array.isArray(s)){const r=s.filter(a=>a.status==="online").length;t.textContent=r}const n=document.getElementById("active-users-count");if(n&&e&&e.active_visitors!==void 0?n.textContent=e.active_visitors:n&&Array.isArray(s)&&(n.textContent=s.length),e){const r=document.getElementById("total-visitors-count");r&&(r.textContent=e.total_visitors||0);const a=document.getElementById("today-visits-count");a&&(a.textContent=e.today_visits||0)}}function y(s){const e=document.querySelector("#countries-table tbody");if(!e)return;let t=[];if(Array.isArray(s))if(s.length>0&&s[0].country!==void 0&&s[0].count!==void 0)t=[...s];else{const r={};s.forEach(a=>{const o=a.country||"Unknown";r[o]||(r[o]=0),r[o]++}),t=Object.entries(r).map(([a,o])=>({country:a,count:o}))}const n=[...t].sort((r,a)=>a.count-r.count).slice(0,5);if(n.length===0){e.innerHTML=`
        <tr>
          <td colspan="3" class="text-center">لا توجد بيانات للعرض</td>
        </tr>
      `;return}e.innerHTML=n.map(r=>{const a=n.reduce((c,R)=>c+R.count,0),o=a>0?Math.round(r.count/a*100):0;return`
        <tr>
          <td>
            <div class="d-flex align-items-center">
              <span>${r.country}</span>
            </div>
          </td>
          <td>${r.count}</td>
          <td>
            <div class="progress" style="height: 6px;">
              <div class="progress-bar bg-primary" style="width: ${o}%" role="progressbar" aria-valuenow="${o}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </td>
        </tr>
      `}).join("")}function q(s){if(!(!d||!u)&&(u.clearLayers(),s&&Array.isArray(s))){const e={"Saudi Arabia":[24.7136,46.6753],Egypt:[30.0444,31.2357],UAE:[25.2048,55.2708],USA:[37.7749,-122.4194],UK:[51.5074,-.1278],France:[48.8566,2.3522],Germany:[52.52,13.405],China:[39.9042,116.4074],Japan:[35.6762,139.6503],Russia:[55.7558,37.6173],Unknown:[0,0]};s.forEach(t=>{let n=e[t.country]||[0,0];n=[n[0]+(Math.random()-.5)*2,n[1]+(Math.random()-.5)*2];const r=L.circleMarker(n,{radius:5,fillColor:"#7367f0",color:"#fff",weight:1,opacity:1,fillOpacity:.8}),a=`
          <div class="visitor-popup">
            <div><strong>العنوان IP:</strong> ${t.ip||"Unknown"}</div>
            <div><strong>الموقع:</strong> ${t.country||"Unknown"}${t.city?` - ${t.city}`:""}</div>
            <div><strong>المتصفح:</strong> ${t.browser||"Unknown"}</div>
            <div><strong>نظام التشغيل:</strong> ${t.os||"Unknown"}</div>
            <div><strong>آخر نشاط:</strong> ${new Date(t.last_active).toLocaleString("ar-SA")}</div>
          </div>
        `;r.bindPopup(a),u.addLayer(r)}),y(s)}}const U=()=>{const s=document.getElementById("visitor-chart");if(!s)return;const e=new ApexCharts(s,{chart:{type:"line",height:300,toolbar:{show:!1},zoom:{enabled:!1}},series:[{name:"Visitors",data:[]}],xaxis:{type:"datetime"},stroke:{curve:"smooth",width:2},colors:["#696cff"]});e.render(),window.visitorChart=e},j=s=>{const e=document.querySelector("#active-users-table tbody");e&&(e.innerHTML=s.map(t=>`
            <tr>
                <td>${t.user_id||"Guest"}</td>
                <td>${t.ip_address||"Unknown"}</td>
                <td>${new Date(t.last_activity).toLocaleString()}</td>
                <td>${t.url||"-"}</td>
                <td>${t.browser||"-"}</td>
                <td>${t.os||"-"}</td>
            </tr>
        `).join(""))},H=s=>{const e=document.getElementById("total-requests"),t=document.getElementById("online-requests"),n=document.getElementById("offline-requests");e&&(e.textContent=s.total),t&&(t.textContent=s.online),n&&(n.textContent=s.offline)},T=async()=>{var s,e;try{const t=await fetch("/dashboard/monitoring/stats",{headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content"),Accept:"application/json"}});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const n=await t.json();console.log("Received stats:",n),(s=n.data)!=null&&s.requestStats&&H(n.data.requestStats),n.activeUsers&&j(n.activeUsers),window.visitorChart&&((e=n.visitorStats)!=null&&e.history)&&window.visitorChart.updateSeries([{name:"Visitors",data:n.visitorStats.history.map(o=>({x:o.timestamp,y:o.count}))}]);const r=document.getElementById("last-updated");r&&(r.textContent=`Last updated: ${new Date().toLocaleTimeString()}`);const a=document.getElementById("total-users");a&&Array.isArray(n.activeUsers)&&(a.textContent=n.activeUsers.length)}catch(t){console.error("Error updating stats:",t)}};U(),T(),setInterval(T,5e3);async function x(){var s;try{const e=await fetch("/dashboard/monitoring/event-logs",{headers:{"X-CSRF-TOKEN":(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"),Accept:"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();return console.log("تم استلام سجلات الأحداث:",t),t.status==="success"&&t.data?p(t.data.events||[]):p(t.events||[]),t}catch(e){return console.error("Error fetching event logs:",e),p([{time:new Date().toISOString(),type:"info",user:"النظام",message:"لا يمكن جلب سجلات الأحداث. يرجى التحقق من اتصالك بالخادم.",icon:"ti-info-circle"}]),{status:"error",message:e.message}}}function p(s){const e=document.querySelector(".timeline-container");if(!e)return;if(!Array.isArray(s)||s.length===0){e.innerHTML='<div class="text-center p-3">لا توجد أحداث لعرضها</div>';return}const t=[...s].sort((n,r)=>new Date(r.time)-new Date(n.time));e.innerHTML=t.map(n=>{const r=new Date(n.time).toLocaleString("ar-SA"),a=n.icon||O(n.type);return`
        <div class="timeline-item">
          <div class="timeline-point ${D(n.type)}">
            <i class="${a}"></i>
          </div>
          <div class="timeline-content">
            <h6 class="mb-1">${n.message}</h6>
            <div class="d-flex justify-content-between">
              <small class="text-muted">${n.user||"system"}</small>
              <small class="text-muted">${r}</small>
            </div>
          </div>
        </div>
      `}).join("")}function O(s){switch(s){case"login":return"ti ti-login";case"logout":return"ti ti-logout";case"update":return"ti ti-refresh";case"create":return"ti ti-plus";case"delete":return"ti ti-trash";case"error":return"ti ti-alert-circle";case"warning":return"ti ti-alert-triangle";case"info":return"ti ti-info-circle";case"file":return"ti ti-file";case"backup":return"ti ti-database";default:return"ti ti-activity"}}function D(s){switch(s){case"login":case"create":return"bg-success";case"error":return"bg-danger";case"warning":return"bg-warning";case"update":case"info":return"bg-info";case"delete":return"bg-secondary";default:return"bg-primary"}}async function f(){var s;try{const e=await fetch("/dashboard/monitoring/error-logs",{headers:{"X-CSRF-TOKEN":(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"),Accept:"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();let n=[];if(t.status==="success"&&t.data&&t.data.recent){n=t.data.recent;const r=document.getElementById("error-count");r&&t.data.count!==void 0&&(r.textContent=t.data.count)}else t.errors&&(n=t.errors);return console.log("تم استلام سجلات الأخطاء:",n),A(n),t}catch(e){return console.error("Error fetching error logs:",e),A([{id:"error-"+Date.now(),timestamp:new Date().toISOString(),type:"Info",message:"لا يمكن جلب سجلات الأخطاء. يرجى التحقق من اتصالك بالخادم.",file:"",line:"",user_id:null}]),{status:"error",message:e.message}}}function A(s){const e=document.querySelector("tbody#error-logs-table");if(!e){console.error("لم يتم العثور على عنصر tbody#error-logs-table");return}const t=e.closest(".card").querySelector(".card-header");if(t&&!t.querySelector("#clear-all-logs")){const r=document.createElement("button");r.id="clear-all-logs",r.className="btn btn-danger btn-sm float-end",r.innerHTML='<i class="ti ti-trash"></i> مسح السجل بالكامل',r.addEventListener("click",function(){confirm("هل أنت متأكد من رغبتك في مسح جميع سجلات الأخطاء؟ هذا الإجراء لا يمكن التراجع عنه.")&&P()}),t.appendChild(r)}if(console.log("تحديث جدول الأخطاء بـ:",s),!Array.isArray(s)||s.length===0){e.innerHTML=`
      <tr>
        <td colspan="6" class="text-center">لا توجد أخطاء مسجلة</td>
      </tr>
    `;return}e.innerHTML=s.map(r=>`
      <tr>
        <td>${new Date(r.timestamp).toLocaleString("ar-SA")}</td>
        <td>${r.type}</td>
        <td>${r.message}</td>
        <td>${r.file?r.file+":"+r.line:"غير متوفر"}</td>
        <td>${r.user_id||"غير مسجل"}</td>
        <td>
          <button class="btn btn-sm btn-danger delete-error" data-error-id="${r.id}">
            <i class="ti ti-trash"></i>
          </button>
        </td>
      </tr>
    `).join(""),e.querySelectorAll(".delete-error").forEach(r=>{r.addEventListener("click",function(){const a=this.getAttribute("data-error-id");confirm("هل أنت متأكد من رغبتك في حذف هذا الخطأ؟")&&F(a)})})}async function F(s){var e;try{const t=await fetch("/dashboard/monitoring/delete-error",{method:"POST",headers:{"X-CSRF-TOKEN":(e=document.querySelector('meta[name="csrf-token"]'))==null?void 0:e.getAttribute("content"),Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({errorId:s})});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);(await t.json()).status==="success"&&f()}catch(t){console.error("Error deleting error log:",t)}}async function P(){var s;try{const e=await fetch("/dashboard/monitoring/clear-error-logs",{method:"POST",headers:{"X-CSRF-TOKEN":(s=document.querySelector('meta[name="csrf-token"]'))==null?void 0:s.getAttribute("content"),Accept:"application/json"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);(await e.json()).status==="success"&&f()}catch(e){console.error("Error clearing error logs:",e)}}});
