const i={init(){this.initEventHandlers(),this.initTooltips(),this.initCharts()},initEventHandlers(){document.querySelectorAll('[data-action="block-ip"]').forEach(t=>{t.addEventListener("click",this.handleBlockIp.bind(this))}),document.querySelectorAll('[data-action="resolve-log"]').forEach(t=>{t.addEventListener("click",this.handleResolveLog.bind(this))});const o=document.querySelector("#security-filters");o&&o.addEventListener("submit",this.handleFilter.bind(this))},initTooltips(){[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(function(t){return new bootstrap.Tooltip(t)})},async handleBlockIp(o){const t=o.currentTarget,s=t.dataset.ip;try{const e=await fetch("/api/dashboard/security/blocked-ips",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({ip_address:s,reason:"Blocked from security dashboard"})}),r=await e.json();if(e.ok)Swal.fire({icon:"success",title:"Success",text:r.message,showConfirmButton:!1,timer:1500}),t.closest("tr").classList.add("table-danger"),t.disabled=!0;else throw new Error(r.message||"Failed to block IP")}catch(e){console.error("Error blocking IP:",e),Swal.fire({icon:"error",title:"Error",text:e.message})}},async handleResolveLog(o){const t=o.currentTarget,s=t.dataset.logId;try{const{value:e}=await Swal.fire({title:"Resolution Notes",input:"textarea",inputLabel:"Please enter resolution notes",inputPlaceholder:"Type your notes here...",showCancelButton:!0,inputValidator:r=>{if(!r)return"You need to write something!"}});if(e){const r=await fetch(`/api/dashboard/security/logs/${s}/resolve`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({notes:e})}),a=await r.json();if(r.ok){Swal.fire({icon:"success",title:"Success",text:a.message,showConfirmButton:!1,timer:1500});const n=t.closest("tr");n.querySelector(".status-badge").textContent="Resolved",n.querySelector(".status-badge").className="badge bg-success",t.disabled=!0}else throw new Error(a.message||"Failed to resolve log")}}catch(e){console.error("Error resolving log:",e),Swal.fire({icon:"error",title:"Error",text:e.message})}},handleFilter(o){o.preventDefault();const t=o.currentTarget,s=new URL(window.location.href),e=new FormData(t);for(const[r,a]of e.entries())a?s.searchParams.set(r,a):s.searchParams.delete(r);window.location.href=s.toString()},initCharts(){if(!document.querySelector("#securityEventsChart"))return;const o=document.querySelector("#securityEventsChart"),t={series:[{name:"Events",data:JSON.parse(o.dataset.events)}],chart:{height:350,type:"area",toolbar:{show:!1}},dataLabels:{enabled:!1},stroke:{curve:"smooth"},xaxis:{type:"datetime",categories:JSON.parse(o.dataset.dates)},tooltip:{x:{format:"dd MMM yyyy"}}};new ApexCharts(o,t).render();const e=document.querySelector("#severityDistributionChart");if(e){const r={series:JSON.parse(e.dataset.values),chart:{type:"donut",height:350},labels:JSON.parse(e.dataset.labels),colors:["#435ebe","#fb7171","#ff9f43","#00cfe8"],responsive:[{breakpoint:480,options:{chart:{width:200},legend:{position:"bottom"}}}]};new ApexCharts(e,r).render()}}};document.addEventListener("DOMContentLoaded",()=>{i.init()});
